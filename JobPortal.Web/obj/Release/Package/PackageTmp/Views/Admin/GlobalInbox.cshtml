@using JobPortal.Domain

@{
    ViewBag.Title = "Inbox";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script src="~/Scripts/highcharts.js"></script>
<script src="~/Scripts/map.js"></script>
<script src="~/Scripts/world.js"></script>
<style>
    .cdate {
        padding-left: 0px;
        list-style-type: none;
    }

        .cdate li {
            display: inline-block;
            width: auto;
        }

    .fcountry {
    }

    .nfield {
        width: 85px;
        text-align: center;
    }
</style>
<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12">
        <div class="title-login">
            <h1 style="margin-top:-15px">Inbox</h1>
            Manage inbox here
        </div>
    </div>
</div>
<div class="clear" style="height:15px;"></div>
<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12">
        @*<span style="font-size:1em; font-weight:bold">Messages By Country</span>*@
        <div id="container" class="list-group-item">

        </div>
    </div>
</div>
<div class="clear" style="height:15px;"></div>
@using (Html.BeginForm())
{
    <div class="list-group-item">
        <div class="row">
            <div class="col-lg-4 col-md-4 col-sm-4">
                <div class="form-group">
                    @Html.Label("Search By Country")

                    @Html.DropDownList("CountryId", new SelectList(SharedService.Instance.GetCountryList(), "Id", "Text"), "SELECT", new { @class = "form-control", @id = "CountryId" })
                    <div id="countryError" style="color:red;"></div>
                </div>
            </div>
            <div class="col-lg-8 col-md-8 col-sm-8">
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6">
                        <div class="form-group">
                            @Html.Label("From Date")
                            <ul class="cdate" title="From Date">
                                <li>
                                    @Html.DropDownList("fd", new SelectList(SharedService.Instance.GetDayList()), "DAY", new { @class = "form-control", @style = "padding:5px;width:64px;" })
                                </li>
                                <li>
                                    @Html.DropDownList("fm", new SelectList(SharedService.Instance.GetMonthList(), "Id", "Name"), "MONTH", new { @class = "form-control", @style = "padding:5px; width:90px;" })
                                </li>
                                <li>
                                    @Html.DropDownList("fy", new SelectList(SharedService.Instance.GetYearList(false, DateTime.Now.Year - 1)), "YEAR", new { @class = "form-control", @style = "padding:5px;width:66px;" })
                                </li>
                            </ul>
                            <div id="fromDateError" style="color:red;"></div>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm-6">
                        <div class="form-group">
                            @Html.Label("To Date")
                            <ul class="cdate" title="To Date">
                                <li>
                                    @Html.DropDownList("td", new SelectList(SharedService.Instance.GetDayList()), "DAY", new { @class = "form-control", @style = "padding:5px;width:64px;" })
                                </li>
                                <li>
                                    @Html.DropDownList("tm", new SelectList(SharedService.Instance.GetMonthList(), "Id", "Name"), "MONTH", new { @class = "form-control", @style = "padding:5px;width:90px;" })
                                </li>
                                <li>
                                    @Html.DropDownList("ty", new SelectList(SharedService.Instance.GetYearList(false, DateTime.Now.Year - 1)), "YEAR", new { @class = "form-control", @style = "padding:5px;width:66px;" })
                                </li>
                            </ul>
                            <div id="toDateError" style="color:red;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <div class="form-group">
                    <input id="Search" type="submit" value="Search" class="btn btn-info pull-right" style="width:105px;" />
                </div>
            </div>
        </div>
    </div>
}
<div>
    <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12">&nbsp;</div>
    </div>
       <table class="table-bordered table-condensed table-responsive" style="width:100%">
        <thead>
            <tr>
                <th>Country</th>
                <th style="width:100px; text-align:center">Individuals</th>
                <th style="width:100px; text-align:center">Companies</th>
                <th style="width:100px; text-align:center">Total</th>
            </tr>
        </thead>
        <tbody id="result"></tbody>
        <tfoot>
            <tr>
                <td></td>
                <td id="iTotal" style="width:100px; text-align:center"></td>
                <td id="cTotal" style="width:100px; text-align:center"></td>
                <td id="aTotal" style="width:100px; text-align:center"></td>
            </tr>
        </tfoot>
    </table>
</div>
<script>
    $(function () {
        var rows = 0;
        var pages = 0;
        var pagesize = 5;
        var pageNumber = 1;
        var individuals = 0;
        var companies = 0;
        var total = 0;
        $.get("/JsonHelper/GlobalInbox", {}, function (result) {

            companies = 0;
            individuals = 0;
            papprovals = 0;
            lapprovals = 0;
            dataPoints = []

            if (result.length > 0) {
                rows = result[0].MaxRows;
                pages = Math.ceil(rows / pagesize);
                individuals = 0;
                companies = 0;
                total = 0;
                $(result).each(function () {
                    individuals = individuals + this.Individuals;
                    companies = companies + this.Companies;
                    total = total + (this.Individuals + this.Companies);
                    var ghtml = "<tr>";
                    ghtml += "<td><a href=\"/admin/InboxList?CountryId=" + this.CountryId + "&type=0&fd=" + $("#fd").val() + "&fm=" + $("#fm").val() + "&fy=" + $("#fy").val() + "&td=" + $("#td").val() + "&tm=" + $("#tm").val() + "&ty=" + $("#ty").val() + "\">" + this.Name + "</a></td>"
                    if (this.Individuals > 0) {
                        ghtml += "<td style=\"text-align:center\"><a href=\"/admin/InboxList?CountryId=" + this.CountryId + "&type=4&fd=" + $("#fd").val() + "&fm=" + $("#fm").val() + "&fy=" + $("#fy").val() + "&td=" + $("#td").val() + "&tm=" + $("#tm").val() + "&ty=" + $("#ty").val() + "\" style=\"color:red\">" + this.Individuals + "</a></td>";
                    } else {
                        ghtml += "<td style=\"text-align:center\">" + this.Individuals + "</td>";
                    }
                    if (this.Companies > 0) {
                        ghtml += "<td style=\"text-align:center\"><a href=\"/admin/InboxList?CountryId=" + this.CountryId + "&type=5&fd=" + $("#fd").val() + "&fm=" + $("#fm").val() + "&fy=" + $("#fy").val() + "&td=" + $("#td").val() + "&tm=" + $("#tm").val() + "&ty=" + $("#ty").val() + "\" style=\"color:red\">" + this.Companies + "</a></td>";
                    } else {
                        ghtml += "<td style=\"text-align:center\">" + this.Companies + "</td>";
                    }
                    ghtml += "<td style=\"text-align:center\">" + (this.Individuals + this.Companies) + "</td>";
                    ghtml += "</tr>";
                    $("#result").append(ghtml);
                    $("#iTotal").text(individuals);
                    $("#cTotal").text(companies);
                    $("#aTotal").text(total);
                    if (this.Code != null || this.Code != "") {
                        if ((this.Individuals + this.Companies) > 0) {
                            dataPoints.push({ code: "" + this.Code, value: (this.Individuals + this.Companies), name: this.CountryName, countryId: this.CountryId });
                        }
                    }
                });
            }

            var mapChart = $('#container').highcharts('Map', {
                title: {
                    text: ''
                },

                mapNavigation: {
                    enabled: true,
                    buttonOptions: {
                        verticalAlign: 'bottom'
                    }
                },

                colorAxis: {
                    min: 1,
                    max: 1000,
                    type: 'logarithmic'
                },
                plotOptions: {
                    series: {
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function () {
                                    window.open("/admin/InboxList?CountryId=" + this.countryId + "&type=0&fd=" + $("#fd").val() + "&fm=" + $("#fm").val() + "&fy=" + $("#fy").val() + "&td=" + $("#td").val() + "&tm=" + $("#tm").val() + "&ty=" + $("#ty").val(), "_blank");
                                }
                            }
                        }
                    }
                },
                series: [{
                    data: dataPoints,
                    mapData: Highcharts.maps['custom/world'],
                    joinBy: ['iso-a2', 'code'],
                    name: 'Messages',
                    allowPointSelect: true,
                    cursor: 'pointer',
                    states: {
                        hover: {
                            color: '#8CEBF7'
                        }
                    },
                    tooltip: {
                        valueSuffix: ''
                    }
                }]
            });
        });
        $("#Search").click(function () {
           
            var isValidStartDate = isValidDate($("#fd").val(), $("#fm").val(), $("#fy").val());
            var isValidEndDate = isValidDate($("#td").val(), $("#tm").val(), $("#ty").val());

            if (isValidStartDate) {
                $("#fromDateError").html("");
                $("#fromDateError").hide();
                $("#Search").enabled = true;
            } else {
                $("#fromDateError").html("Provide correct from date!");
                $("#fromDateError").show();
                $("#Search").enabled = false;
            }

            if (isValidEndDate) {
                $("#toDateError").html("");
                $("#toDateError").hide();
                $("#Search").enabled = true;
            } else {
                $("#toDateError").html("Provide correct to date!");
                $("#toDateError").show();
                $("#Search").enabled = false;
            }
            if ((isValidStartDate == true && isValidEndDate == true)) {
               
                    $.get("/JsonHelper/GlobalInbox", { countryId: $("#CountryId").val(), fd: $("#fd").val(), fm: $("#fm").val(), fy: $("#fy").val(), td: $("#td").val(), tm: $("#tm").val(), ty: $("#ty").val() }, function (result) {
                        if (result.length > 0) {
                            $("#result").empty();
                            rows = result[0].MaxRows;
                            pages = Math.ceil(rows / pagesize);
                            individuals = 0;
                            companies = 0;
                            total = 0;
                            $(result).each(function () {
                                individuals = individuals + this.Individuals;
                                companies = companies + this.Companies;
                                total = total + (this.Individuals + this.Companies);
                                var ghtml = "<tr>";
                                ghtml += "<td><a href=\"/admin/InboxList?CountryId=" + this.CountryId + "&type=0&fd=" + $("#fd").val() + "&fm=" + $("#fm").val() + "&fy=" + $("#fy").val() + "&td=" + $("#td").val() + "&tm=" + $("#tm").val() + "&ty=" + $("#ty").val() + "\">" + this.Name + "</a></td>"
                                if (this.Individuals > 0) {
                                    ghtml += "<td style=\"text-align:center\"><a href=\"/admin/InboxList?CountryId=" + this.CountryId + "&type=4&fd=" + $("#fd").val() + "&fm=" + $("#fm").val() + "&fy=" + $("#fy").val() + "&td=" + $("#td").val() + "&tm=" + $("#tm").val() + "&ty=" + $("#ty").val() + "\" style=\"color:red\">" + this.Individuals + "</a></td>";
                                } else {
                                    ghtml += "<td style=\"text-align:center\">" + this.Individuals + "</td>";
                                }
                                if (this.Companies > 0) {
                                    ghtml += "<td style=\"text-align:center\"><a href=\"/admin/InboxList?CountryId=" + this.CountryId + "&type=5&fd=" + $("#fd").val() + "&fm=" + $("#fm").val() + "&fy=" + $("#fy").val() + "&td=" + $("#td").val() + "&tm=" + $("#tm").val() + "&ty=" + $("#ty").val() + "\" style=\"color:red\">" + this.Companies + "</a></td>";
                                } else {
                                    ghtml += "<td style=\"text-align:center\">" + this.Companies + "</td>";
                                }
                                ghtml += "<td style=\"text-align:center\">" + (this.Individuals + this.Companies) + "</td>";
                                ghtml += "</tr>"
                                $("#result").append(ghtml);
                                $("#iTotal").text(individuals);
                                $("#cTotal").text(companies);
                                $("#aTotal").text(total);
                            });
                        }
                    });

                    var pgn = pageNumber;
                    $(window).scroll(function () {
                        if (pages >= pgn) {
                            pgn++;
                        }

                        if (pages > 0 && pages >= pgn) {
                            $.get("/JsonHelper/GlobalInbox", { countryId: $("#CountryId").val(), fd: $("#fd").val(), fm: $("#fm").val(), fy: $("#fy").val(), td: $("#td").val(), tm: $("#tm").val(), ty: $("#ty").val(), pageNumber: pgn }, function (result) {
                                if (result.length > 0) {
                                    $(result).each(function () {
                                        individuals = individuals + this.Individuals;
                                        companies = companies + this.Companies;
                                        total = total + (this.Individuals + this.Companies);
                                        var ghtml = "<tr>";
                                        ghtml += "<td><a href=\"/admin/InboxList?CountryId=" + this.CountryId + "&type=0&fd=" + $("#fd").val() + "&fm=" + $("#fm").val() + "&fy=" + $("#fy").val() + "&td=" + $("#td").val() + "&tm=" + $("#tm").val() + "&ty=" + $("#ty").val() + "\">" + this.Name + "</a></td>"
                                        if (this.Individuals > 0) {
                                            ghtml += "<td style=\"text-align:center\"><a href=\"/admin/InboxList?CountryId=" + this.CountryId + "&type=4&fd=" + $("#fd").val() + "&fm=" + $("#fm").val() + "&fy=" + $("#fy").val() + "&td=" + $("#td").val() + "&tm=" + $("#tm").val() + "&ty=" + $("#ty").val() + "\" style=\"color:red\">" + this.Individuals + "</a></td>";
                                        } else {
                                            ghtml += "<td style=\"text-align:center\">" + this.Individuals + "</td>";
                                        }
                                        if (this.Companies > 0) {
                                            ghtml += "<td style=\"text-align:center\"><a href=\"/admin/InboxList?CountryId=" + this.CountryId + "&type=5&fd=" + $("#fd").val() + "&fm=" + $("#fm").val() + "&fy=" + $("#fy").val() + "&td=" + $("#td").val() + "&tm=" + $("#tm").val() + "&ty=" + $("#ty").val() + "\" style=\"color:red\">" + this.Companies + "</a></td>";
                                        } else {
                                            ghtml += "<td style=\"text-align:center\">" + this.Companies + "</td>";
                                        }
                                        ghtml += "<td style=\"text-align:center\">" + (this.Individuals + this.Companies) + "</td>";
                                        ghtml += "</tr>"
                                        $("#result").append(ghtml);
                                        $("#iTotal").text(individuals);
                                        $("#cTotal").text(companies);
                                        $("#aTotal").text(total);
                                    });
                                }
                            });
                        }

                    });
                
                return false;
            } else {
                return false;
            }
        });

        var pgn = pageNumber;
        $(window).scroll(function () {
            if (pages >= pgn) {
                pgn++;
            }

            if (pages > 0 && pages >= pgn) {
                $.get("/JsonHelper/GlobalInbox", { countryId: $("#CountryId").val(), fd: $("#fd").val(), fm: $("#fm").val(), fy: $("#fy").val(), td: $("#td").val(), tm: $("#tm").val(), ty: $("#ty").val(), pageNumber : pgn }, function (result) {
                    if (result.length > 0) {
                        $(result).each(function () {
                            individuals = individuals + this.Individuals;
                            companies = companies + this.Companies;
                            total = total + (this.Individuals + this.Companies);
                            var ghtml = "<tr>";
                            ghtml += "<td><a href=\"/admin/InboxList?CountryId=" + this.CountryId + "&type=0&fd=" + $("#fd").val() + "&fm=" + $("#fm").val() + "&fy=" + $("#fy").val() + "&td=" + $("#td").val() + "&tm=" + $("#tm").val() + "&ty=" + $("#ty").val() + "\">" + this.Name + "</a></td>"
                            if (this.Individuals > 0) {
                                ghtml += "<td style=\"text-align:center\"><a href=\"/admin/InboxList?CountryId=" + this.CountryId + "&type=4&fd=" + $("#fd").val() + "&fm=" + $("#fm").val() + "&fy=" + $("#fy").val() + "&td=" + $("#td").val() + "&tm=" + $("#tm").val() + "&ty=" + $("#ty").val() + "\" style=\"color:red\">" + this.Individuals + "</a></td>";
                            } else {
                                ghtml += "<td style=\"text-align:center\">" + this.Individuals + "</td>";
                            }
                            if (this.Companies > 0) {
                                ghtml += "<td style=\"text-align:center\"><a href=\"/admin/InboxList?CountryId=" + this.CountryId + "&type=5&fd=" + $("#fd").val() + "&fm=" + $("#fm").val() + "&fy=" + $("#fy").val() + "&td=" + $("#td").val() + "&tm=" + $("#tm").val() + "&ty=" + $("#ty").val() + "\" style=\"color:red\">" + this.Companies + "</a></td>";
                            } else {
                                ghtml += "<td style=\"text-align:center\">" + this.Companies + "</td>";
                            }
                            ghtml += "<td style=\"text-align:center\">" +(this.Individuals+ this.Companies) + "</td>";
                            ghtml += "</tr>"
                            $("#result").append(ghtml);
                            $("#iTotal").text(individuals);
                            $("#cTotal").text(companies);
                            $("#aTotal").text(total);
                        });
                    }
                });
            }

        });
    })
</script>