@using JobPortal.Domain
@{
    ViewBag.Title = "Payments";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script src="~/Scripts/highcharts.js"></script>
<script src="~/Scripts/map.js"></script>
<script src="~/Scripts/world.js"></script>
<script src="~/Scripts/dataTables.fixedHeader.min.js"></script>
<script src="~/Scripts/jquery.tmpl.min.js"></script>
<style>
    table tbody, table thead {
        display: block;
    }

    table tbody {
        overflow: auto;
        max-height: 385px;
    }

    table {
        width: 100%;
    }

    th:first-child {
        width: 260px;
    }

    td:first-child {
        width: 260px;
    }
</style>
<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12">
        <div class="title-login">
            <h1 style="margin-top: -15px;">Payments</h1>
            View Payments here
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12">
        <span style="font-size:1em; font-weight:bold">Payments By Country</span>
        <div class="form-group">
            <div id="container1" class="list-group-item" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12">
        <span style="font-size:1em; font-weight:bold">Overall Payments</span>
        <div class="form-group">
            <div id="container" class="list-group-item" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
        </div>
    </div>
</div>
<div class="clear" style="height:15px"></div>

<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12">
        <form id="SearchForm">
            <div class="row">
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon" style="color:#000; text-align:left">From Date</span>
                            @Html.DropDownList("fd", new SelectList(SharedService.Instance.GetDayList()), "DAY", new { @class = "form-control" })
                            <span class="input-group-btn" style="width:0px"></span>
                            @Html.DropDownList("fm", new SelectList(SharedService.Instance.GetMonthList(), "Id", "Name"), "MONTH", new { @class = "form-control" })
                            <span class="input-group-btn" style="width:0px"></span>
                            @Html.DropDownList("fy", new SelectList(SharedService.Instance.GetYearList(false, DateTime.Now.Year - 1)), "YEAR", new { @class = "form-control" })
                        </div>
                        <div id="fromDateError" style="color:red;"></div>
                    </div>
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon" style="color:#000; text-align:left">To Date</span>
                            @Html.DropDownList("td", new SelectList(SharedService.Instance.GetDayList()), "DAY", new { @class = "form-control" })
                            <span class="input-group-btn" style="width:0px"></span>
                            @Html.DropDownList("tm", new SelectList(SharedService.Instance.GetMonthList(), "Id", "Name"), "MONTH", new { @class = "form-control" })
                            <span class="input-group-btn" style="width:0px"></span>
                            @Html.DropDownList("ty", new SelectList(SharedService.Instance.GetYearList(false, DateTime.Now.Year - 1)), "YEAR", new { @class = "form-control" })
                        </div>
                        <div id="toDateError" style="color:red;"></div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-2 col-sm-2">
                    <div class="form-group">
                        <input id="Search" type="submit" value="Search" class="btn btn-info btn-block" style="height:31px" />
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12">
        <table class="table table-bordered table-condensed table-striped table-fixed" style="width:100%; margin-bottom:0px;">
            <thead>
                <tr>
                    <th>Country</th>
                    <th style="width:125px; text-align:center">Free (US$)</th>
                    <th style="width:125px; text-align:center">Basic (US$)</th>
                    <th style="width:125px; text-align:center">Advance (US$)</th>
                    <th style="width:125px; text-align:center">Total (US$)</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="row" style="margin-top:0px; padding-top:0px;">
            <div class="col-lg-12 col-md-12 text-right">
                <div class="list-group-item">
                    <span><b>Grand Total: </b></span><span id="GrandTotal"></span>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(function () {
        var url = "/JsonHelper/SalesByCountry?";
        $.post(url, {}, function (data) {
            var dataPoints = [];
            var totalDataPoints = [];
            var total = 0;
            var totalPlus = 0;
            var totalAdvanced = 0;
            var totalPro = 0;
            $.each(data, function (i, item) {
                var t = (item.Free + item.Basic + item.Advance);
                if (t > 0) {
                    dataPoints.push({ code: "" + item.CountryCode, value: t, name: item.CountryName, countryId: item.CountryId });
                }
                item.Total = t;
                item.fd = $("#fd").val();
                item.fm = $("#fm").val();
                item.fy = $("#fy").val();
                item.td = $("#td").val();
                item.tm = $("#tm").val();
                item.ty = $("#ty").val();
                $("#tmplrow").tmpl(item).appendTo("#tableBody");
                total += t;
                totalPlus += item.Free;
                totalAdvanced += item.Basic;
                totalPro += item.Advance;
            });
            $("#GrandTotal").html(total);
            if (total > 0) {
                totalDataPoints.push({ name: "Free", y: totalPlus });
                totalDataPoints.push({ name: "Basic", y: totalAdvanced });
                totalDataPoints.push({ name: "Advance", y: totalPro });
                totalDataPoints.push({ name: "Total", y: total });
            }
            var mapChart = $('#container1').highcharts('Map', {
                title: {
                    text: ''
                },

                mapNavigation: {
                    enabled: true,
                    buttonOptions: {
                        verticalAlign: 'bottom'
                    }
                },

                colorAxis: {
                    min: 1,
                    max: 1000,
                    type: 'logarithmic'
                },
                plotOptions: {
                    series: {
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function () {
                                    window.open("/Admin/SalesDetails?countryId=" + this.countryId, "_blank");
                                }
                            }
                        }
                    }
                },
                series: [{
                    data: dataPoints,
                    mapData: Highcharts.maps['custom/world'],
                    joinBy: ['iso-a2', 'code'],
                    name: 'Sales',
                    allowPointSelect: true,
                    cursor: 'pointer',
                    states: {
                        hover: {
                            color: '#8CEBF7'
                        }
                    },
                    tooltip: {
                        valueSuffix: ''
                    }
                }]
            });

            $('#container').empty();
            $('#container').highcharts({

                colors: ['#FFB61C', '#87D42E', '#475d8f', '#434348'],
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    type: 'pie'
                },
                events: {
                    click: function () {
                        alert('chart clicked');
                    }
                },
                title: {
                    text: ''
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>US${point.y}</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        depth: 10,
                        dataLabels: {
                            enabled: true,
                            distance: -30,
                            format: 'US${point.y}',
                            shadow: false,
                            style: {
                                textShadow: "0 0 0px contrast, 0 0 0px contrast",
                            }
                        }
                    }
                },
                series: [{
                    type: 'pie',
                    name: 'Package',
                    data: totalDataPoints,
                    showInLegend: true,
                    dataLabels: {
                        enabled: true,
                        distance: -30,
                        format: 'US${point.y}',
                        shadow: false
                    }
                }]
            });
        });

        $("#Search").click(function () {
            var isValidStartDate = isValidDate($("#fd").val(), $("#fm").val(), $("#fy").val());
            var isValidEndDate = isValidDate($("#td").val(), $("#tm").val(), $("#ty").val());

            if (isValidStartDate) {
                $("#fromDateError").html("");
                $("#fromDateError").show();
                $("#Search").enabled = true;
            } else {
                $("#fromDateError").html("Provide correct from date!");
                $("#fromDateError").show();
                $("#Search").enabled = false;
            }

            if (isValidEndDate) {
                $("#toDateError").html("");
                $("#toDateError").show();
                $("#Search").enabled = true;
            } else {
                $("#toDateError").html("Provide correct to date!");
                $("#toDateError").show();
                $("#Search").enabled = false;
            }

            if (isValidStartDate == true && isValidEndDate == true) {

                var jsonForm = $("#SearchForm").serializeObject();
                var url = "/JsonHelper/SalesByCountry?";
                $.post(url, jsonForm, function (data) {
                    $("#tableBody").empty();
                    var dataPoints = [];
                    var totalDataPoints = [];
                    var total = 0;
                    var totalPlus = 0;
                    var totalAdvanced = 0;
                    var totalPro = 0;
                    if (data.length > 0) {
                        $.each(data, function (i, item) {
                            dataPoints.push({ code: "" + item.CountryCode, value: (item.Free + item.Basic + item.Advance), name: item.CountryName, countryId: item.CountryId });
                            item.Total = (item.Free + item.Basic + item.Advance);
                            item.fd = $("#fd").val();
                            item.fm = $("#fm").val();
                            item.fy = $("#fy").val();
                            item.td = $("#td").val();
                            item.tm = $("#tm").val();
                            item.ty = $("#ty").val();
                            $("#tmplrow").tmpl(item).appendTo("#tableBody");
                            total += (item.Free + item.Basic + item.Advance);
                            totalPlus += item.Free;
                            totalAdvanced += item.Basic;
                            totalPro += item.Advance;
                        });
                        $("#GrandTotal").html(total);
                    }
                    $('#container1').empty();
                    var mapChart = $('#container1').highcharts('Map', {
                        title: {
                            text: ''
                        },

                        mapNavigation: {
                            enabled: true,
                            buttonOptions: {
                                verticalAlign: 'bottom'
                            }
                        },

                        colorAxis: {
                            min: 1,
                            max: 1000,
                            type: 'logarithmic'
                        },
                        plotOptions: {
                            series: {
                                cursor: 'pointer',
                                point: {
                                    events: {
                                        click: function () {
                                            window.open("/Admin/SalesDetails?countryId=" + this.countryId, "_blank");
                                        }
                                    }
                                }
                            }
                        },
                        series: [{
                            data: dataPoints,
                            mapData: Highcharts.maps['custom/world'],
                            joinBy: ['iso-a2', 'code'],
                            name: 'Payments',
                            allowPointSelect: true,
                            cursor: 'pointer',
                            states: {
                                hover: {
                                    color: '#8CEBF7'
                                }
                            },
                            tooltip: {
                                valueSuffix: ''
                            }
                        }]
                    });

                    if (total > 0) {
                        totalDataPoints.push({ name: "Free", y: totalPlus });
                        totalDataPoints.push({ name: "Basic", y: totalAdvanced });
                        totalDataPoints.push({ name: "Advance", y: totalPro });
                        totalDataPoints.push({ name: "Total", y: total });
                    }
                    $('#container').empty();
                    $('#container').highcharts({

                        colors: ['#FFB61C', '#87D42E', '#475d8f', '#434348'],
                        chart: {
                            plotBackgroundColor: null,
                            plotBorderWidth: null,
                            plotShadow: false,
                            type: 'pie'
                        },
                        events: {
                            click: function () {
                                alert('chart clicked');
                            }
                        },
                        title: {
                            text: ''
                        },
                        tooltip: {
                            pointFormat: '{series.name}: <b>US${point.y}</b>'
                        },
                        plotOptions: {
                            pie: {
                                allowPointSelect: true,
                                cursor: 'pointer',
                                depth: 10,
                                dataLabels: {
                                    enabled: true,
                                    distance: -30,
                                    format: 'US${point.y}',
                                    shadow: false,
                                    style: {
                                        textShadow: "0 0 0px contrast, 0 0 0px contrast",
                                    }
                                }
                            }
                        },
                        series: [{
                            type: 'pie',
                            name: 'Package',
                            data: totalDataPoints,
                            showInLegend: true,
                            dataLabels: {
                                enabled: true,
                                distance: -30,
                                format: 'US${point.y}',
                                shadow: false
                            }
                        }]
                    });
                });
            }
            return false;
        });
    });
</script>
<script id="tmplrow" type="text/x-jquery-tmpl">
    <tr>
        <td><a href="/admin/salesdetails?countryId=${CountryId}&fd=${fd}&fm=${fm}&fy=${fy}&td=${td}&tm=${tm}&ty=${ty}" class="clink">${CountryName}</a></td>
        <td style="width:125px; text-align:center">${Free}</td>
        <td style="width:125px; text-align:center">${Basic}</td>
        <td style="width:125px; text-align:center">${Advance}</td>
        <td style="width:125px; text-align:center">${Total}</td>
    </tr>
</script>
